import{r as l,j as e,d as K,B as n,f as t,h,i as Q,k as X,A as R,l as Y,P as Z,m as ee,n as ae,o as C,p as c,q as oe,s as $,D as B,t as M,u as L,b as S,v as te,w as P,x as re}from"./mui-Czmlt3Wi.js";import{a as v}from"./index-xsH4HHeE.js";import{A as m}from"./api-C-m1HPol.js";import"./vendor-DJG_os-6.js";function ce(){const[E,k]=l.useState([]),[b,T]=l.useState(!0),[w,s]=l.useState(""),[O,g]=l.useState(!1),[W,y]=l.useState(!1),[i,F]=l.useState(null),[I,q]=l.useState(!1),[d,D]=l.useState({titulo:"",descricao:"",nomeMotorista:"",arquivo:null});l.useEffect(()=>{j()},[]);const j=async()=>{try{T(!0),s("");const a=localStorage.getItem("token"),o=JSON.parse(localStorage.getItem("empresa")||"{}");if(!a){s("Token não encontrado - redirecionando para login"),localStorage.clear(),setTimeout(()=>{window.location.href="/login"},2e3);return}if(!o.empresaId||!o.tipo){s("Dados da empresa não encontrados - refaça o login"),localStorage.clear(),setTimeout(()=>{window.location.href="/login"},2e3);return}const r=o.tipo==="ESTRADA_FACIL"?`${m}/documentos/pendentes`:`${m}/documentos/empresa/${o.empresaId}`,p=await v.get(r,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}}),f=Array.isArray(p.data)?p.data:p.data?.data||[];k(f),s("")}catch(a){a.response?.status===401?(s("Sessão expirada. Redirecionando para login..."),localStorage.clear(),setTimeout(()=>{window.location.href="/login"},2e3)):a.response?.status===403?s("Acesso negado. Verifique suas permissões."):a.response?.status===500?s("Erro interno do servidor. Tente novamente em alguns minutos."):s("Erro ao carregar documentos: "+(a.response?.data?.message||a.message)),k([])}finally{T(!1)}},U=async()=>{try{q(!0),s("");const a=localStorage.getItem("token"),o=JSON.parse(localStorage.getItem("empresa")||"{}");if(!d.arquivo){s("Selecione um arquivo para enviar");return}if(!d.titulo.trim()){s("Digite um título para o documento");return}const r=new FormData;r.append("arquivo",d.arquivo),r.append("titulo",d.titulo),r.append("descricao",d.descricao||""),r.append("nomeMotorista",d.nomeMotorista||""),r.append("empresaId",o.empresaId);const p=await v.post(`${m}/documentos/enviar`,r,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"multipart/form-data"}});g(!1),D({titulo:"",descricao:"",nomeMotorista:"",arquivo:null}),j()}catch(a){s("Erro ao enviar documento: "+(a.response?.data?.message||a.message))}finally{q(!1)}},V=l.useCallback(a=>{const o=a.target.files[0];D(r=>({...r,arquivo:o}))},[]),A=l.useCallback((a,o)=>{D(r=>({...r,[a]:o}))},[]),z=async a=>{try{const o=localStorage.getItem("token"),r=await fetch(`${m}/documentos/${a}/arquivo`,{headers:{Authorization:`Bearer ${o}`}});if(!r.ok){r.status===403?s("Você não tem permissão para visualizar este arquivo"):s("Erro ao carregar arquivo: "+r.status);return}const p=await r.blob(),f=URL.createObjectURL(p);window.open(f,"_blank"),setTimeout(()=>URL.revokeObjectURL(f),5e3)}catch{s("Erro ao visualizar arquivo")}},J=async a=>{try{const o=localStorage.getItem("token"),r=await v.get(`${m}/documentos/${a}`,{headers:{Authorization:`Bearer ${o}`}});F(r.data),y(!0)}catch{s("Erro ao carregar detalhes do documento")}},_=async a=>{try{const o=localStorage.getItem("token"),r=await v.post(`${m}/documentos/${a}/aprovar`,"",{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});j()}catch(o){s("Erro ao aprovar documento: "+(o.response?.data?.message||o.message))}},H=async a=>{try{const o=localStorage.getItem("token"),r=await v.post(`${m}/documentos/${a}/rejeitar`,"",{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});j()}catch(o){s("Erro ao rejeitar documento: "+(o.response?.data?.message||o.message))}},N=l.useCallback(a=>{switch(a){case"PENDENTE":return"warning";case"APROVADO":return"success";case"REJEITADO":return"error";default:return"default"}},[]),G=l.useCallback(a=>a?new Date(a).toLocaleString("pt-BR"):"N/A",[]),x=l.useMemo(()=>JSON.parse(localStorage.getItem("empresa")||"{}"),[]),u=l.useMemo(()=>x.tipo==="ESTRADA_FACIL",[x.tipo]);return e.jsxs(K,{maxWidth:"lg",sx:{mt:4},children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:4},children:[e.jsxs("div",{children:[e.jsx(t,{variant:"h4",gutterBottom:!0,children:u?"🔧 Painel do Administrador":`📋 Dashboard - ${x.razaoSocial||"Despachante"}`}),e.jsx(t,{variant:"subtitle1",color:"text.secondary",children:u?"Documentos Pendentes de Aprovação":"Seus Documentos Enviados"}),e.jsxs(t,{variant:"caption",display:"block",sx:{mt:1,fontFamily:"monospace"},children:["🏢 Tipo: ",e.jsx("strong",{children:x.tipo})," | 📄 CNPJ: ",e.jsx("strong",{children:x.cnpj})," | 🆔 ID: ",e.jsx("strong",{children:x.empresaId})]})]}),e.jsxs(n,{children:[e.jsx(h,{variant:"outlined",startIcon:e.jsx(Q,{}),onClick:j,disabled:b,sx:{mr:2},children:b?"Carregando...":"Atualizar"}),!u&&e.jsx(h,{variant:"contained",startIcon:e.jsx(X,{}),color:"primary",onClick:()=>g(!0),children:"Enviar Documento"})]})]}),w&&e.jsx(R,{severity:"error",sx:{mb:3},children:w}),b?e.jsx(R,{severity:"info",children:e.jsx(t,{children:"🔄 Carregando documentos..."})}):e.jsx(Y,{component:Z,children:e.jsxs(ee,{children:[e.jsx(ae,{children:e.jsxs(C,{children:[e.jsx(c,{children:e.jsx("strong",{children:"ID"})}),e.jsx(c,{children:e.jsx("strong",{children:"Tipo"})}),e.jsx(c,{children:e.jsx("strong",{children:"Status"})}),e.jsx(c,{children:e.jsx("strong",{children:"Data Envio"})}),u&&e.jsx(c,{children:e.jsx("strong",{children:"Empresa"})}),u&&e.jsx(c,{children:e.jsx("strong",{children:"Visualizar"})}),e.jsx(c,{children:e.jsx("strong",{children:"Ações"})})]})}),e.jsx(oe,{children:E.length===0?e.jsx(C,{children:e.jsx(c,{colSpan:u?7:5,align:"center",children:e.jsx(t,{color:"text.secondary",sx:{py:4},children:u?"📝 Nenhum documento pendente de aprovação":"📋 Nenhum documento enviado ainda"})})}):E.map((a,o)=>e.jsxs(C,{children:[e.jsx(c,{children:a.id||"N/A"}),e.jsx(c,{children:a.tipo||"N/A"}),e.jsx(c,{children:e.jsx($,{label:a.status||"PENDENTE",color:N(a.status),size:"small"})}),e.jsx(c,{children:G(a.dataEnvio)}),u&&e.jsx(c,{children:a.empresa?.razaoSocial||"N/A"}),u&&e.jsx(c,{children:e.jsx(h,{size:"small",variant:"text",color:"primary",onClick:()=>z(a.id),children:"📎 Ver Arquivo"})}),e.jsx(c,{children:u&&a.status==="PENDENTE"?e.jsxs(n,{children:[e.jsx(h,{size:"small",color:"success",sx:{mr:1},onClick:()=>_(a.id),children:"✅ Aprovar"}),e.jsx(h,{size:"small",color:"error",onClick:()=>H(a.id),children:"❌ Rejeitar"})]}):e.jsx(h,{size:"small",variant:"outlined",onClick:()=>J(a.id),children:"👁️ Ver Detalhes"})})]},a.id||o))})]})}),e.jsxs(B,{open:O,onClose:()=>g(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(M,{children:"📤 Enviar Novo Documento"}),e.jsx(L,{children:e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:2,mt:2},children:[e.jsx(S,{label:"Título do Documento",value:d.titulo,onChange:a=>A("titulo",a.target.value),required:!0,fullWidth:!0}),e.jsx(S,{label:"Descrição",value:d.descricao,onChange:a=>A("descricao",a.target.value),multiline:!0,rows:3,fullWidth:!0}),e.jsx(S,{label:"Nome do Motorista",value:d.nomeMotorista,onChange:a=>A("nomeMotorista",a.target.value),fullWidth:!0}),e.jsxs(n,{children:[e.jsx(t,{variant:"body2",sx:{mb:1},children:"Selecione o arquivo:"}),e.jsx(te,{type:"file",onChange:V,inputProps:{accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"},fullWidth:!0}),d.arquivo&&e.jsxs(t,{variant:"caption",color:"success.main",sx:{mt:1,display:"block"},children:["✅ Arquivo selecionado: ",d.arquivo.name]})]})]})}),e.jsxs(P,{children:[e.jsx(h,{onClick:()=>g(!1),children:"Cancelar"}),e.jsx(h,{onClick:U,variant:"contained",disabled:I||!d.arquivo||!d.titulo.trim(),startIcon:e.jsx(re,{}),children:I?"Enviando...":"Enviar Documento"})]})]}),e.jsxs(B,{open:W,onClose:()=>y(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(M,{children:"📄 Detalhes do Documento"}),e.jsx(L,{children:i&&e.jsxs(n,{sx:{mt:2},children:[e.jsxs(n,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:2,mb:3},children:[e.jsxs(n,{children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"Título"}),e.jsx(t,{variant:"body1",children:i.titulo})]}),e.jsxs(n,{children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"Status"}),e.jsx($,{label:i.status,color:N(i.status),size:"small"})]}),e.jsxs(n,{children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"Motorista"}),e.jsx(t,{variant:"body1",children:i.nomeMotorista||"Não informado"})]}),e.jsxs(n,{children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"Data de Envio"}),e.jsx(t,{variant:"body1",children:new Date(i.dataEnvio).toLocaleString("pt-BR")})]}),e.jsxs(n,{children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"Empresa Remetente"}),e.jsx(t,{variant:"body1",children:i.empresaRemetente?.razaoSocial})]}),i.dataAprovacao&&e.jsxs(n,{children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"Data de Aprovação"}),e.jsx(t,{variant:"body1",children:new Date(i.dataAprovacao).toLocaleString("pt-BR")})]})]}),i.descricao&&e.jsxs(n,{sx:{mb:3},children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"Descrição"}),e.jsx(t,{variant:"body1",children:i.descricao})]}),i.comentarios&&e.jsxs(n,{sx:{mb:3},children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"Comentários da Aprovação"}),e.jsx(t,{variant:"body1",children:i.comentarios})]}),e.jsxs(n,{sx:{mb:3},children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Arquivo"}),e.jsxs(t,{variant:"body2",sx:{mb:2},children:["📎 ",i.nomeArquivoOriginal]}),e.jsx(h,{variant:"contained",color:"primary",onClick:()=>z(i.id),sx:{mr:1},children:"📥 Abrir/Download Arquivo"})]})]})}),e.jsx(P,{children:e.jsx(h,{onClick:()=>y(!1),children:"Fechar"})})]})]})}export{ce as default};
